# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

template(name="<%= 'logentriestemplate_' + @logentries_name %>"
         type="string"
         string="<%= @logentries_token %> <%= @node_identity %> %syslogtag% %msg%\n"
)


<% if @rsyslog_ruleset %>
ruleset(name="<%= @rsyslog_ruleset %>"
        queue.filename="<%= 'mainqueue_' + @logentries_name %>"
	queue.size="200000"
	queue.type="LinkedList"
	queue.maxdiskspace="100M"
	queue.saveonshutdown="on"){
<% end %>
<% if @rsyslog_tls_enable %>
<%= @rsyslog_selector %> action(name="<%= 'action_' + @logentries_name %>"
                                type="omfwd"
				Protocol="tcp"
				Target="api.logentries.com"
				Port="20000"
				StreamDriverMode="1"
				StreamDriver="gtls"
				StreamDriverAuthMode="x509/name"
				StreamDriverPermittedPeers="*.logentries.com"
				Template="<%= 'logentriestemplate_' + @logentries_name %>"
				action.resumeRetryCount="-1"
			        queue.filename="<%= 'actionqueue_' + @logentries_name %>"
                         	queue.size="200000"
                        	queue.type="LinkedList"
				queue.maxdiskspace="100M"
			        queue.saveonshutdown="on")

<% else %>
<%= @rsyslog_selector %> action(name="<%= 'action_' + @logentries_name %>"
                                type="omfwd"
				Protocol="tcp"
				Target="api.logentries.com"
				Port="10000"
				Template="<%= 'logentriestemplate_' + @logentries_name %>"
				action.resumeRetryCount="-1"
			        queue.filename="<%= 'actionqueue_' + @logentries_name %>"
                         	queue.size="200000"
                        	queue.type="LinkedList"
				queue.maxdiskspace="100M"
			        queue.saveonshutdown="on")

<% end %>
<% if @rsyslog_ruleset %>
}
<% end %>

input(type="imfile"
      File="<%= @log_filename %>"
<% if @rsyslog_tag %>
      Tag="<%= "#{@rsyslog_tag}:" %>"
<% end %>
      StateFile="<%= @state_file %>"
<% if @syslog_facility %>
      Facility="<%= @syslog_facility %>"
<% end %>
<% if @rsyslog_ruleset %>
      Ruleset="<%= @rsyslog_ruleset %>"
<% end %>
)
